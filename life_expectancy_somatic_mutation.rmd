---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(readxl)
library(ggplot2)
library(factoextra)
library(FactoMineR)
library('PCAtools')
library(ppcor)
library(boot)
library(ape)
library(ade4)
library("dplyr")
library(caper)
library(nlme)
library('googlesheets4')
library(gridExtra)
library('phytools')
library(colorspace)
library(ggpubr)
library(lemon)
library("gplots")
library(devtools)
library(ggtree)
library(cowplot)
library(colorspace)
library("ggplotify")
library(ggheatmap)
library('ComplexHeatmap')
library(pheatmap)

```


### Calculate the logarithms of the life history traits and add them as new columns
```{r fig.width=4.5, fig.height=3}

## LOAD dataset

lht=read_sheet('https://docs.google.com/spreadsheets/d/1gQKRh5ixhlj8CRG7NM6uOFkg3PQXyd3e2aTJ6U-x91I/edit?usp=share_link',sheet='1j - Data for analysis')

## Set species name as rowname for phylogenetic analysis later
d=lht
d=as.data.frame(d)
rownames(d)=gsub(' ','_',d$`Species name`)
d$`Species name`=gsub(' ','_',d$`Species name`)
colnames(d)=gsub(' ','_',colnames(d))
colnames(d)=lapply(colnames(d),function(x) paste0(tolower(substr(x,1,1)),substr(x,2,nchar(x))))


## Calculate log transformation of selected  columns
cols_to_be_log_transformed=c('lifespan','somatic_mutation_rate','respiratory_rate','resting_heart_rate','adult_mass',
                             'female_sexual_maturity','male_sexual_maturity',
                             'mass_specific_BMR')


# Collect the log transformed column names in vector
log_transformed_cols=c()
for (col in cols_to_be_log_transformed){
  log_colname=paste(c('log',col),collapse='_')
  d[,log_colname]=log10(d[,col])
  log_transformed_cols=append(log_colname,log_transformed_cols)
}

d[d$phylogenetic_grandorder_order=='Perissodactyla and Artiodactyla','phylogenetic_grandorder_order']='Perissodactyla &\nArtiodactyla'
```
## Read phylogenetic tree data
## 1. Read tree that has been constructed using mtDNA
## 2. Read multiple trees (1000 trees from vertlife.org) into a multi-phylo object and get a consensus tree
## 2.1 There ara 3 diffetent methods to build a consensus tree 
## 3. Root trees in order to use them with caper's pgls function -> midpoint root method

```{r}
## Read the 10000 trees acquired from vertlife.org into multi-phylo object 
multi_tree_10000_completed=read.nexus('Phylogenetic_analysis/10000_tip_dated_completed_5911_species.nex', force.multi = TRUE)
multi_tree_10000=multi_tree_10000_completed

## Check if any of the trees do not contain all 15 species and collect them
trees_to_drop=c()
    for (name in names(multi_tree_10000)){
      t=multi_tree_10000[[name]]
      if (length(t$tip.label)<15){
      trees_to_drop=append(tree_to_drop,name)
      }
    }
## Drop trees containing less then 15 species  
multi_tree_10000=multi_tree_10000[!is.element(names(multi_tree_10000),trees_to_drop)]

## Create consensus trees. More on the methods  http://blog.phytools.org/2016/03/method-to-compute-consensus-edge.html
## Rename Canis lupus (grey wolf) to Canis lupus familiaris (dog) to match species names of the dataset and tree

cons_tree_10000=consensus.edges(multi_tree_10000,method='least.squares')
cons_tree_10000$tip.label[grepl('Canis',cons_tree_10000$tip.label)]='Canis_lupus_familiaris'

plot(midpoint.root(cons_tree_10000),main=paste('least squares method - 10 000 trees',seq=' - '))

```


##    1. Midpoint root the selected consensus tree for analysis with the caper package
##    2. Save previously created rooted consensus tree
```{r}
trees=list(least_squares=cons_least_squares_10000,mean_edge=cons_mean_edge_10000)

tree=cons_tree_10000

## Root the selected tree for analysis
rooted_tree=midpoint.root(tree)
plot(rooted_tree)

## Delete internal node names, as they overlap with tip-label names and cause an error with comparative-data function
rooted_tree$node.label=NULL
comp_dat=comparative.data(phy=rooted_tree, data=d, names.col=species_name, vcv = TRUE,warn.dropped = F,na.omit=F)

tree=rooted_tree

saveRDS(tree,file='rooted_tree.Rds')



```

## Load saved rooted tree and create comparative data for caper
```{r}
rooted_tree=readRDS(file='rooted_tree.Rds')


rooted_tree$node.label=NULL
comp_dat=comparative.data(phy=rooted_tree, data=d, names.col=species_name, vcv = TRUE,warn.dropped = F,na.omit=F)
tree=rooted_tree
```

### Create Figure 1
### 1.PLot phylogenetic tree of species with 3 main branches color coded
### 2. PLot heatmap of traits, where only the traits get clustered, the species have the same order as on the phylo. tree
### 3. PCA of traits with the main branches indicated 
```{r fig.width=15.5,fig.height=11.5}
library("gplots")
library(ggtree)
library(cowplot)
library(colorspace)
library("ggplotify")
library('ComplexHeatmap')


## Initialize column names to include in Phyl.tree plot,Heatmap ,PCA

colnames_for_anal=c('log_lifespan','log_somatic_mutation_rate','log_respiratory_rate','log_resting_heart_rate','log_adult_mass',
                    'log_female_sexual_maturity','log_male_sexual_maturity','litter_size','log_mass_specific_BMR') 
                

my_cols=qualitative_hcl(length(unique(d$phylogenetic_grandorder_order)),palette = "Dark 3") 

## Delelete the '_' character from the names of the species
tree_for_ggplot=tree
tree_for_ggplot$tip.label=d[match(tree$tip.label,d$species_name),'common_name']

## Set the main branch label for the tree
branch_groups=list()

for (group in (unique(d$phylogenetic_grandorder_order))){
  species_in_group=d[d$phylogenetic_grandorder_order==group,'common_name']
  species_in_group=gsub('_',' ',species_in_group)
  branch_groups[[group]]=unlist(species_in_group)
}

## Sort list by names 
orders_grandorders=c('Carnivora','Perissodactyla &\nArtiodactyla','Rodentia','Lagomorpha','Primates')
branch_groups=branch_groups[orders_grandorders]


## Add manually the nodes of the different orders/grandorders for clade labelling with geom_cladelab later (mrca=most recent common ancestor)
mrca_node_numbers=c(20,18,26,28)
clade_df=data.frame(node=mrca_node_numbers,name=orders_grandorders[orders_grandorders!='Lagomorpha'],fill=my_cols[-4])


# Create new tree where groups are added to the tree itself
tree_for_ggplot <- groupOTU(tree_for_ggplot, branch_groups)
tree_for_ggplot_with_original_string<-ggtree(tree_for_ggplot)

tree_for_ggplot$tip.label[grepl('colobus',tree_for_ggplot$tip.label)]='Black-and-white\ncolobus'
tree_for_ggplot$tip.label[grepl('mole-rat',tree_for_ggplot$tip.label)]='Naked\nmole-rat'
tree_for_ggplot$tip.label[grepl('lemur',tree_for_ggplot$tip.label)]='Ring-tailed\nlemur'


subplot_label_fontsize=17

### PLOT PHYLOGENETIC TREE
treeplot=ggtree(tree_for_ggplot,layout='fan',size=1.5,open.angle = 160)+ #coord_flip()+ # add "aes(color=group)" to ggtree function to color tips of tree
        geom_cladelab(data = clade_df,
                    mapping = aes(node = node, label = name, color =name),
                    fontsize = 12,fontface='bold',textcolour='black',offset.text=2,offset=50,barsize=5,angle='auto',align=FALSE)+
        geom_hilight(data = clade_df,
                    mapping = aes(node = node, label = name, fill = name),show.legend= FALSE)+
        geom_hilight(node=12,fill=my_cols[4])+
        #geom_text(aes(label=node),hjust=-.3,size=15)+
        geom_tiplab(size=12,show.legend= FALSE,offset = 1,geom='text',lineheight=0.8)+
        theme(plot.margin = unit(c(5,0,-12,3), "cm"),
              legend.text = element_text(size=28,face='bold'),
              legend.key.size = unit(1.9, 'cm'),
              legend.position=c(0.95,0.5),
              legend.title=element_text(size=33,face='bold'))+
        #xlim(NA,250)+
        #ylim(0,25)+
        scale_color_manual(name=NULL,values=c(my_cols,'black'), breaks=names(branch_groups),guide='none')+
        scale_fill_manual(name=NULL,values=c(my_cols,'black'), breaks=names(branch_groups),guide='none')+
        guides(override.aes = aes(label = ""),color = guide_legend(override.aes = list(linetype = 0, size=15)))
        

## Rotate tree and scale it up a little bit
treeplot=ggplotify::as.ggplot(treeplot, angle=-15, scale=1.15,hjust=0.05) + 
        annotate("text", label = "bold(a)", x = 0.1, y = 0.9,size=subplot_label_fontsize,parse=TRUE)


#### HEATMAP
## Reorder dataframe for heatmap visualization according to phyl.tree order
data_for_heatmap=d[match(get_taxa_name(tree_for_ggplot_with_original_string),d$common_name),colnames_for_anal]
rownames(data_for_heatmap)=gsub('_',' ',get_taxa_name(tree_for_ggplot_with_original_string))

## Rename specific metabolic rate, drop W_per_g from the end
colnames(data_for_heatmap)[grepl('spec_metabolic',colnames(data_for_heatmap))]='log_mass_specific_BMR'

## Reshape one string and add Female and Male symbol
rownames(data_for_heatmap)[grepl('colobus',rownames(data_for_heatmap))]='Black-and-white\ncolobus'
rownames(data_for_heatmap)[grepl('mole-rat',rownames(data_for_heatmap))]='Naked\nmole-rat'
rownames(data_for_heatmap)[grepl('lemur',rownames(data_for_heatmap))]='Ring-tailed\nlemur'
colnames(data_for_heatmap)[grepl('female',colnames(data_for_heatmap))]=paste0('log_time_to_sexual_maturity_','\U2640')
colnames(data_for_heatmap)[grepl('male',colnames(data_for_heatmap))]=paste0('log_time_to_sexual_maturity_','\U2642')

## Substitute underscore for space and capitalize the strings
colnames(data_for_heatmap)=gsub('_',' ',colnames(data_for_heatmap))
colnames(data_for_heatmap)=tools::toTitleCase(tolower(colnames(data_for_heatmap)))
colnames(data_for_heatmap)=gsub('Mass Specific Bmr','Mass-Specific BMR',colnames(data_for_heatmap))


## PLOT HEATMAP OF TRAITS
hmap=Heatmap((scale(data_for_heatmap)),
             rect_gp = gpar(col = "black", lwd = 3),
             color=colorRampPalette(c("navy", "white", "red"))(3),
             cluster_rows=FALSE,
             row_split=factor(d[match(get_taxa_name(tree_for_ggplot_with_original_string),d$common_name),'phylogenetic_grandorder_order'],
                                 levels=orders_grandorders),
             row_gap = unit(10, "mm"),
             row_title=c(NULL),
             row_names_gp = gpar(fontsize = 32), #add 'col=my_cols,' to the gpar() function color y labels
             column_names_gp = gpar(fontsize = 32),
             column_names_side = "top",
             top_annotation =HeatmapAnnotation(ann=anno_empty(border = FALSE),
                                               height = unit(2.3, "cm")),
             row_names_side = "left",
             column_dend_height = unit(30, "mm"),
             column_dend_side = "bottom",
             column_dend_gp=gpar(lwd=5),
             width = ncol(data_for_heatmap)*unit(26, "mm"), 
             height = nrow(data_for_heatmap)*unit(24, "mm"),
             column_names_rot = 50,
             heatmap_legend_param = list(title='Scaled\nvalues\n',
                                         title_gp = gpar(fontsize = 25,fontface='bold'),
                                         title_position = "topcenter",
                                         direction = "vertical",
                                         labels_gp= gpar(fontsize = 20,fontface='bold'),
                                         legend_height = unit(8, "cm"),
                                         grid_width = unit(2, "cm")))

hmap=as.ggplot(hmap)+theme(plot.margin = unit(c(-5,0,-12,0),"cm"))+
                      annotate("text", label = "bold(b)", x = 0.2, y = 0.88,size=subplot_label_fontsize,parse=TRUE)#+
                    

### PLOT PCA
## Extract data from dataframe containing all the data
d_num_for_pca=d[,colnames_for_anal]

## Substitute "_" for whitespace in the common animal names
rownames(d_num_for_pca)=gsub('_',' ',d[,'common_name'])

## Add newline chracter for animal names that are too long for one line
rownames(d_num_for_pca)[grepl('colobus',rownames(d_num_for_pca))]='Black-and-white\ncolobus'
rownames(d_num_for_pca)[grepl('mole-rat',rownames(d_num_for_pca))]='Naked\nmole-rat'
rownames(d_num_for_pca)[grepl('lemur',rownames(d_num_for_pca))]='Ring-tailed\nlemur'

## Calculate PCA results
res.pca=PCA((d_num_for_pca),graph=F)
# Extract PCA results as dataframe
pca_df=as.data.frame(res.pca$ind$coord[,c(1,2)],check.names = FALSE)
colnames(pca_df) <- gsub( "\\.","", colnames(pca_df))
pca_df['species_names']=rownames(pca_df)

## Add non-numeric data to dataframe for eventual coloring of PCA plot
d_num_for_pca['species_name']=rownames(d_num_for_pca)
d_num_for_pca[,'phylogenetic_grandorder_order']=d[,'phylogenetic_grandorder_order']

labels_for_pca=factor(d[,'phylogenetic_grandorder_order'],
                                 levels=orders_grandorders)

pca_plot=ggplot(data=pca_df,aes_string(x='Dim1',y='Dim2',label='species_names'))+
                      geom_hline(yintercept=0,color = "grey",size = 1,linetype = 2)+
                      geom_vline(xintercept=0,color = "grey",size = 1,linetype = 2)+
                      geom_point(size = 9,aes(color=labels_for_pca))+
                      geom_text_repel(size = 13,lineheight = .8,box.padding = 1,min.segment.length = Inf,max.overlaps = 20)+
                      theme(text = element_text(size = 30),
                            legend.title=element_blank(),
                            legend.text=element_text(size=32),
                            legend.position=c(.88,.8),
                            legend.background = element_rect(colour = 'black', fill = 'white', size = 1),
                            axis.title.x=element_text(size=28,face='bold'),
                            axis.text.x=element_text(size=28,face='bold'),
                            axis.text.y=element_text(size=28,face='bold'),
                            axis.title.y=element_text(size=28,face='bold'),
                            panel.background = element_rect(fill = "white"),
                            panel.grid.major =  element_blank(),
                            panel.grid.minor = element_blank(),
                            plot.margin = unit(c(-8,0,0,0),"cm")
                            )+
                      scale_color_manual(name = '',labels = levels(labels_for_pca),values= my_cols)+
                      guides(color = guide_legend(override.aes = list(linetype = 0, size=9)))+
                      ggtitle('')#+ 
                      #ylim(c(-2.6,1.5))+xlim(c(-5.8,4))
                      
pca_plot=pca_plot + annotate("text", label = "bold(c)", x = -5.8, y =2,size=subplot_label_fontsize,parse=TRUE)

first_col=cowplot::plot_grid(treeplot,pca_plot,nrow = 2,rel_heights=c(0.6, 0.4))
whole_plot=cowplot::plot_grid(first_col,hmap,ncol=2,rel_heights=c(0.4, 0.6),rel_widths=c(1,1))
print(whole_plot)
ggsave(filename=('life_expectancy_figs/Figure 1.pdf'),plot=whole_plot,limitsize = FALSE)


```

#### Creation of Supplementary Figure 1 & 2:
####  Diagnostic plots of univariete and multivariate linear regressions with/without phylogenetic correction, in order to detect phylogenetic signal in the residuals
```{r fig.width=13, fig.height=7}


# function to extract legend from plot
get_only_legend <- function(plot) {
  plot_table <- ggplot_gtable(ggplot_build(plot))
  legend_plot <- which(sapply(plot_table$grobs, function(x) x$name) == "guide-box")
  legend <- plot_table$grobs[[legend_plot]]
  return(legend)
}

## Variables to consider
lm_colnames=c('log_somatic_mutation_rate','log_respiratory_rate','log_resting_heart_rate','log_adult_mass',
                    'log_female_sexual_maturity','log_male_sexual_maturity','litter_size','log_mass_specific_BMR')

## Dependent variables in linear model
dependent_vars=c('log_lifespan')

## Figure names
figure_names=c('Supplementary Figure 1','Supplementary Figure 2')

## Figure subtexts
figure_subtext=c("Diagnostic plots (QQplot, Resiudal plot, Scale-Location plot) of the Fitted univariate models. The first rows show the diagnostic plots \nfor the ordinary least squares (OLS) models, where Pagel's lambda=0 meaning statistical independence between the species. The \nsecond row of plots belong to the phylogenetic generalised least squares model (PGLS) where the Pagel's lambda parameter was \nset to a fixed value of 1, assuming a Brownian-motion model of evolution and a strong phylogenetic signal.",
                 "Diagnostic plots (QQplot, Resiudal plot, Scale-Location plot) of the Fitted multivariate models. The first rows show the diagnostic plots \nfor the ordinary least squares (OLS) models, where Pagel's lambda=0 meaning statistical independence between the species. The \nsecond row of plots belong to the phylogenetic generalised least squares model (PGLS) where the Pagel's lambda parameter was \nset to a fixed value of 1, assuming a Brownian-motion model of evolution and a strong phylogenetic signal.")

## Create list with fixed independent variable names. This/These variable(s) will be used as a fixed independent variable(s) in the model alongside one additional independent variable that is added to the formula. If fixed independent variable==NULL, then only the additional independent variable as considered in the model

fixed_independent_varnames=list(NA,'log_somatic_mutation_rate')

## Create list for the letters used for labeling the subplots
subplot_letters=c('a','b','c','d','e','f','g','h')

n_of_figs=0

for (n in 1:length(figure_names)){
  ## Set figure name
  fig_name=figure_names[n]
  fig_subtext=figure_subtext[n]
  
  ## Fixed independent variables in linear model
  fixed_independent_vars=fixed_independent_varnames[n]
  
  ## Select column names (=variables) to loop through -> drop the variables that are used for the model fitting
  colnames_to_loop=lm_colnames[!is.element(lm_colnames,fixed_independent_vars)]
  
  ## Subset the subplot letters to the number of variables (number of subplots is equal to number of variables used as independent variables)
  fig_subplot_letters=subplot_letters[1:length(colnames_to_loop)]
  
  ## Create list to collect the grid object of plots (3x2 subplots per object) into -> all the subplots of a figure
  subplot_list=list()
  
  for (k in 1:length(colnames_to_loop)){
      ## Set the variable that is used in modelling
      var=colnames_to_loop[k]
      subplot_letter=fig_subplot_letters[k]

      ## Create formula dependent_var ~ fixed_independent_vars + var
      ## If fixed_independent_vars==NA, then just consider dependent_vars~var in model, so the 'NULL' won't show as string later in figure subtitle
      if (is.na(fixed_independent_vars)==TRUE){
        fo=as.formula(paste(c(dependent_vars,var),collapse='~'))
      } else {
        fo=as.formula(paste(c(dependent_vars,c(paste(c(fixed_independent_vars,var),collapse = '+'))),collapse='~'))}
 
      
      ## Fit OLS linear model
      lm_model=lm(formula=fo,data=d)
  
      ## Fit phylogenetic generalised linear model (PGLS) with a fixed lambda value=1 
      ## -> This assumes a strong phylogenetic signal (==Brownian-motion evolution model of the traits)
      pgls_model=pgls(fo,data = comp_dat, lambda = 1)
      
      ## Create list of models to loop through
      model_list=list(lm_model,pgls_model)
      names(model_list)=c("No phylogenetic signal (Pagel's lambda=0)","Strong phylogenetic signal (Pagel's lambda=1)")
      
      ## Create list to collect individual plots into
      individual_plot_list=list()
      
      ## Subplots labels
      subplot_labels=list(first_row=c('a','b','c'),second_row=c('d','e','f'))
      
      for (j in 1:length(names(model_list))){
        model_name=names(model_list)[j]
        model=model_list[[model_name]]
        
        subplot_row=names(subplot_labels)[j]
      
        dd=data.frame(resid(model))
        colnames(dd)='residuals'
        dd[,'common_name']=d[base::match(rownames(dd),d$species_name),'common_name']
        dd[,'phylogenetic_grandorder_order']=d[base::match(dd$common_name,d$common_name),'phylogenetic_grandorder_order']
        dd[,'Fitted']=fitted(model)
        dd[,'scaled_residuals']=scale(dd[,'residuals'])
        dd[,'sqrt_abs_std_residuals']=sqrt(abs(scale(dd[,'residuals'])))
        
        
        ## Calcluate QQplot x and y axis values, and then add them to a dataframe in order to label the species afterwards in further plots
        ## as point labeling is not available in stat_qq
        p=ggplot(data=dd,aes(sample=scaled_residuals)) +  # Create QQplot with ggplot2 package
              stat_qq()+
              stat_qq_line()
        
        ## Save the x and y values from QQplot and add them to the data (order them as the data)
        ordered_resid_df=ggplot_build(p)$data[[1]]
        dd[,'x']=ordered_resid_df[order(match(ordered_resid_df$y,dd$scaled_residuals)),'x']
        dd[,'y']=ordered_resid_df[order(match(ordered_resid_df$y,dd$scaled_residuals)),'y']

        ## Initialize plot text fontsizes  
        plot_title_size=20
        axis_label_size=20
        axis_text_size=17
        legend_text_size=20
        point_size=3
        plot_text_size=6
        subplot_label_x_coord=0.09
        subplot_label_y_coord=0.95
        my_cols=qualitative_hcl(length(unique(d$phylogenetic_grandorder_order)),palette = "Dark 3")
        labels_for_legend=factor(d[,'phylogenetic_grandorder_order'],
                                 levels=c('Carnivora','Ungulata','Rodentia','Lagomorpha','Primates'))
  
        
        ## Plot QQplot and save it to list
        p1=ggplot(data=dd,aes_string(x='x',y='y',color='phylogenetic_grandorder_order'))+geom_point(size=point_size)+
                  geom_text_repel(label = dd$common_name,size=plot_text_size)+
                  ggtitle(paste('QQplot','\n',model_name,sep=' '))+
                  stat_qq_line(aes_string(sample='y'),col = "black")+
                  theme(plot.title = element_text(size=plot_title_size,face='bold',hjust = 0.5),
                        axis.text.x=element_text(size=axis_text_size),
                        axis.title.x=element_text(size=axis_label_size),
                        axis.text.y=element_text(size=axis_text_size),
                        axis.title.y=element_text(size=axis_label_size))+
                  xlab('Theoretical quantiles')+ylab('Sample quantiles')+
                  scale_color_manual(name = '',breaks=levels(labels_for_legend),values= my_cols)+
                  labs(tag=subplot_labels[[subplot_row]][1])+
                  theme(legend.position="none",
                        plot.tag = element_text(face = 'bold',size=axis_label_size*2),
                        plot.tag.position = c(subplot_label_x_coord, subplot_label_y_coord))
                  
                  #annotate("text", label = "bold(a)", x = -2.7, y = 0.88,size=15,parse=TRUE)
        
      
        individual_plot_list[paste(var,model_name,'qqplot',sep='_')]=list(p1)
        
        
        ## PLot residual plot and save it to a list
        p2=ggplot(data=dd,aes(x=Fitted,y=scaled_residuals,color=phylogenetic_grandorder_order))+
                  geom_point(size=point_size,show.legend = FALSE)+
                  geom_text_repel(label = dd$common_name,size=plot_text_size)+
                  Hmisc::stat_plsmo(aes(x=Fitted,y=residuals),inherit.aes=FALSE)+
                  ggtitle(paste('Residual plot','\n',model_name,sep=' '))+
                  theme(plot.title = element_text(size=plot_title_size,face='bold',hjust = 0.5),
                        axis.text.x=element_text(size=axis_text_size),
                        axis.title.x=element_text(size=axis_label_size),
                        axis.text.y=element_text(size=axis_text_size),
                        axis.title.y=element_text(size=axis_label_size))+
                  scale_color_manual(name = '',breaks=levels(labels_for_legend),values= my_cols)+
                  labs(tag=subplot_labels[[subplot_row]][2])+
                  theme(legend.position="none",
                        plot.tag = element_text(face = 'bold',size=axis_label_size*2),
                        plot.tag.position = c(subplot_label_x_coord, subplot_label_y_coord))+
                  ylim(c(-2.5,2.5))+
                  ylab('Scaled residuals')
        
        individual_plot_list[paste(var,model_name,'residual_plot',sep='_')]=list(p2)
        
        ## PLot Scale-location plot
        p3=ggplot(data=dd,aes(x=Fitted,y=sqrt_abs_std_residuals,color=phylogenetic_grandorder_order))+
                  geom_point(size=point_size)+
                  geom_text_repel(label = dd$common_name,size=plot_text_size)+
                  Hmisc::stat_plsmo(aes(x=Fitted,y=sqrt_abs_std_residuals),inherit.aes=FALSE)+
                  ggtitle(paste('Scale-location','\n',model_name,sep=' '))+
                  theme(plot.title = element_text(size=plot_title_size,face='bold',hjust = 0.5),
                        axis.text.x=element_text(size=axis_text_size),
                        axis.title.x=element_text(size=axis_label_size),
                        axis.text.y=element_text(size=axis_text_size),
                        axis.title.y=element_text(size=axis_label_size))+
                  scale_color_manual(name = '',breaks=levels(labels_for_legend),values= my_cols)+
                  labs(tag=subplot_labels[[subplot_row]][3])+
                  theme(legend.position="none",
                        plot.tag = element_text(face = 'bold',size=axis_label_size*2),
                        plot.tag.position = c(subplot_label_x_coord*1.3, subplot_label_y_coord))+
                  ylim(c(0,2))+
                  ylab(bquote(sqrt('|Scaled residuals|')))+
                  theme(legend.position="none")
        
        individual_plot_list[paste(var,model_name,'scale_location_plot',sep='_')]=list(p3)
        
        
        ## Create ggplot object just to extract its legend
        plot_for_legend=ggplot(data=dd,aes(x=Fitted,y=residuals))+
                  geom_point(aes(color=phylogenetic_grandorder_order))+
                  theme(legend.text=element_text(size=legend_text_size,face='bold'))+
                  scale_color_manual(name = '',labels = levels(labels_for_legend),values= my_cols)+
                  guides(fill=guide_legend(title=''),
                         color = guide_legend(override.aes = list(size = 5)))
        
        ## Extract legend
        combined_legend=get_only_legend(plot_for_legend)
    
        
      }
      ## Create grid of 6 plots
      plots=cowplot::plot_grid(plotlist = individual_plot_list,ncol = 3)
      
      ## Add legend to the plot
      plots_with_legend=cowplot::plot_grid(plots,combined_legend,ncol=2,rel_widths = c(1, .087))
      
      
      ## Create title to subplot
      title_string=tools::toTitleCase(tolower(gsub('_',' ',format(fo))))
      title_string=gsub('Mass Specific Bmr','Mass-Specific BMR',title_string)
      subplot_title <- ggdraw() + draw_label(title_string, size = 35,fontface='bold') + theme(plot.background = element_rect(fill="white", color = NA))
        #draw_text(subplot_letter, x=0.05,y=0.5,size = 65,fontface='bold') 
                       #
      
      ## Add title to subplot
      plots_with_legend_title=cowplot::plot_grid(subplot_title, plots_with_legend, ncol=1, rel_heights=c(0.06, 0.99),scale = 1)
      
      print(plots_with_legend_title)

      fig_name=paste('Supplementary Figure',n_of_figs+k)
      ggsave(filename=paste0('life_expectancy_figs/',fig_name,'.pdf'),plot=plots_with_legend_title,limitsize = FALSE,dpi = 300,bg='white')
      ggsave(filename=paste0('life_expectancy_figs/',fig_name,'.png'),plot=plots_with_legend_title,limitsize = FALSE,dpi = 300,bg='white')
      
      ## Add subplot to the list of subplots that contains all the subplots for the figure
      #subplot_list[[subplot_letter]]=(as.ggplot(plots_with_legend_title))
    }
    n_of_figs=k
    ## Create figure where with all the subplots in one main plot
    # figure_plot=cowplot::plot_grid(plotlist=subplot_list,ncol=1)
    # 
    # ## Create and add figure name and subtext to figure
    # figure_title=ggdraw() + draw_text(fig_name, x=0.23,y=0.8,size = 65,fontface='bold') + 
    #             draw_label(fig_subtext, size = 32,hjust = 0, vjust = 0.08, x=0.056,y=0.008)
    # figure_plot_with_title=cowplot::plot_grid(figure_title, figure_plot, ncol=1, rel_heights=c(0.026, 1),scale = 0.97)
    # 
    # ## Save figure as pdf
    # ggsave2(filename=paste0('life_expectancy_figs/',fig_name,'.pdf'),plot=figure_plot_with_title,limitsize = FALSE)
    # 
    # print(figure_plot_with_title)
  
}
```







